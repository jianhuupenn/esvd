---
title: "Zeisel Week 2"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE,autodep=TRUE, cache.comments=TRUE)
```

Column sum and sparsity
===

```{r, echo = F}
rm(list=ls())
load("../../SOUP/data/zeisel.rda")

dat <- zeisel$counts
dim(dat)

sparsity_vec2 <- apply(dat, 2, function(x){
  length(which(x!=0))
})
sum_vec2 <- colSums(dat)

plot(sparsity_vec2, sum_vec2)
```

```{r, echo = F}
quantile_sum <- quantile(sum_vec2, prob = 0.95)
plot(sparsity_vec2, sum_vec2, ylim = c(0, quantile_sum))

idx <- which(sum_vec2 <= quantile_sum)
dat <- dat[,idx]

sparsity_vec <- apply(dat, 2, function(x){
  length(which(x!=0))
})
sum_vec <- colSums(dat)
```

Least sparse genes (most non-zeros)

```{r, echo = F}
par(mfrow = c(2,2))
idx <- order(sparsity_vec, decreasing = T)[1:4]
cell_idx <- as.numeric(as.factor(zeisel$cell.info[,2]))
for(i in 1:4){
  plot(jitter(sort(dat[,idx[i]])), col = c(1:7)[cell_idx[order(dat[,idx[i]])]])
}
```


Most sparse genes (most zeros)

```{r, echo = F}
par(mfrow = c(2,2))
idx <- order(sparsity_vec, decreasing = F)[1:4]
cell_idx <- as.numeric(as.factor(zeisel$cell.info[,2]))
for(i in 1:4){
  plot(jitter(sort(dat[,idx[i]])), col = c(1:7)[cell_idx[order(dat[,idx[i]])]])
}
```

Medium sparse genes

```{r, echo = F}
par(mfrow = c(2,2))
mid <- floor(length(sparsity_vec)/2)
idx <- order(sparsity_vec, decreasing = T)[mid:(mid+3)]
cell_idx <- as.numeric(as.factor(zeisel$cell.info[,2]))
for(i in 1:4){
  plot(jitter(sort(dat[,idx[i]])), col = c(1:7)[cell_idx[order(dat[,idx[i]])]])
}
```

Lingxue selected genes
===

```{r, echo = F}
idx <- which(colnames(dat) %in% zeisel$select.genes)
col_vec <- rep("black", length(sparsity_vec2))
col_vec[idx] <- "red"
pch_vec <- rep(1, length(sparsity_vec2))
pch_vec[idx] <- 16
plot(sparsity_vec2, sum_vec2, ylim = c(0, quantile_sum),
     col = col_vec, pch = pch_vec)
```


Most sparse genes
===

```{r, echo = F}
idx <- order(sparsity_vec, decreasing = T)[1:700]
col_vec <- rep("black", length(sparsity_vec))
col_vec[idx] <- "red"
pch_vec <- rep(1, length(sparsity_vec))
pch_vec[idx] <- 16
plot(sparsity_vec, sum_vec, ylim = c(0, quantile_sum),
     col = col_vec, pch = pch_vec)
```

```{r, echo = F}
dat2 <- dat[,idx]
res_svd <- svd(dat2)
```

Singular values

```{r, echo = F}
plot(sort(res_svd$d, decreasing = T)[1:50], pch = 16)
```

Left eigenvectors (Cells)

```{r, echo = F}
plot(res_svd$u[,1], res_svd$u[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```

Right eigenvectors (Genes)

```{r, echo = F}
plot(res_svd$v[,1], res_svd$v[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```


Analysis using most sparse genes
===

Removing cells with almost no counts anywhere

```{r, echo = F}
cell_sparsity <- apply(dat2, 1, function(x){
  length(which(x!=0))
})

plot(sort(cell_sparsity))
lines(c(-1e4, 1e4), rep(ncol(dat2)/2, 2), col = "red", lwd = 2)
```


```{r, echo = F}
idx <- which(cell_sparsity >= ncol(dat2)/2)
dat3 <- dat2[idx,]
cell_types <- zeisel$cell.info[idx,2]

dim(dat3)
cbind(table(cell_types)/table(zeisel$cell.info[,2]), table(zeisel$cell.info[,2]))
```

```{r}
par(mfrow = c(1,2))
plot(table(dat3))
plot(table(dat3), ylim = c(0, 100))
```

```{r, echo = F}
res_svd <- svd(dat3)
```

Singular values

```{r, echo = F}
plot(sort(res_svd$d, decreasing = T)[1:50], pch = 16)
```

Left eigenvectors (Cells)

```{r, echo = F}
plot(res_svd$u[,1], res_svd$u[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```

Right eigenvectors (Genes)

```{r, echo = F}
plot(res_svd$v[,1], res_svd$v[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```

Modeling approximation

```{r}
dat_approx <- res_svd$u[,1:2] %*% diag(res_svd$d[1:2]) %*% t(res_svd$v[,1:2])
residual <- dat3 - dat_approx

set.seed(10)
idx <- sample(prod(dim(dat3)), 5e5)
plot(as.vector(dat_approx)[idx], as.vector(residual)[idx], pch = 16, xlab = "mean",
     ylab = "residual", col = rgb(0,0,0,0.1))
lines(c(-1e4, 1e4), rep(0,2), col = "red", lwd = 2)
```

```{r}
plot(as.numeric(dat_approx)[idx], as.numeric(dat)[idx], col = rgb(0,0,0,0.1))
mean_val <- seq(0, 50, by = 0.25)
lines(mean_val, mean_val, col = "red", lwd = 2)
sd_top <- mean_val + 3*sqrt(mean_val)
sd_bot <- mean_val - 3*sqrt(mean_val)
lines(mean_val, sd_top, col = "red", lwd = 2, lty = 2)
lines(mean_val, sd_bot, col = "red", lwd = 2, lty = 2)
```

Thresholding matrix
===

```{r, echo = F}
dat4 <- dat3
dat4[dat4 >= 20] <- 20
```

```{r, echo = F}
res_svd <- svd(dat4)
```

Singular values

```{r, echo = F}
plot(sort(res_svd$d, decreasing = T)[1:50], pch = 16)
```

Left eigenvectors (Cells)

```{r, echo = F}
plot(res_svd$u[,1], res_svd$u[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```

Right eigenvectors (Genes)

```{r, echo = F}
plot(res_svd$v[,1], res_svd$v[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```

Modeling approximation

```{r}
dat_approx <- res_svd$u[,1:2] %*% diag(res_svd$d[1:2]) %*% t(res_svd$v[,1:2])
residual <- dat4 - dat_approx

set.seed(10)
idx <- sample(prod(dim(dat4)), 5e5)
plot(as.vector(dat_approx)[idx], as.vector(residual)[idx], pch = 16, xlab = "mean",
     ylab = "residual", col = rgb(0,0,0,0.1))
lines(c(-1e4, 1e4), rep(0,2), col = "red", lwd = 2)
```

```{r}
plot(as.numeric(dat_approx)[idx], as.numeric(dat)[idx], col = rgb(0,0,0,0.1))
mean_val <- seq(0, 50, by = 0.25)
lines(mean_val, mean_val, col = "red", lwd = 2)
sd_top <- mean_val + 3*sqrt(mean_val)
sd_bot <- mean_val - 3*sqrt(mean_val)
lines(mean_val, sd_top, col = "red", lwd = 2, lty = 2)
lines(mean_val, sd_bot, col = "red", lwd = 2, lty = 2)
```



Column ANOVA
===

```{r, echo = F}
anova_func <- function(x){
  uniq <- unique(zeisel$cell.info[,2])
  k <- length(uniq)
  n <- length(x)

  between <- sum(sapply(uniq, function(k){
    idx <- which(zeisel$cell.info[,2] == k)
    length(idx)*(mean(x[idx]) - mean(x))^2
  }))/(k-1)

  within <- sum(sapply(unique(zeisel$cell.info[,2]), function(k){
    idx <- which(zeisel$cell.info[,2] == k)
    sum((x[idx]-mean(x[idx]))^2)
  }))/(n-k)

  between/within
}

anova_vec <- apply(dat, 2, anova_func)
plot(sort(anova_vec))
```

Largest

```{r, echo = F}
par(mfrow = c(2,2))
cell_idx <- as.numeric(as.factor(zeisel$cell.info[,2]))
idx <- order(anova_vec, decreasing = T)[1:4]
for(i in 1:4){
  plot(jitter(sort(dat[,idx[i]])), col = c(1:7)[cell_idx[order(dat[,idx[i]])]])
}
```

Smallest

```{r, echo = F}
par(mfrow = c(2,2))
cell_idx <- as.numeric(as.factor(zeisel$cell.info[,2]))
idx <- order(anova_vec, decreasing = F)[1:4]
for(i in 1:4){
  plot(jitter(sort(dat[,idx[i]])), col = c(1:7)[cell_idx[order(dat[,idx[i]])]])
}
```

Medium

```{r, echo = F}
par(mfrow = c(2,2))
cell_idx <- as.numeric(as.factor(zeisel$cell.info[,2]))
mid <- floor(length(anova_vec)/2)
idx <- order(anova_vec, decreasing = F)[mid:(mid+4)]
for(i in 1:4){
  plot(jitter(sort(dat[,idx[i]])), col = c(1:7)[cell_idx[order(dat[,idx[i]])]])
}
```

```{r, echo = F}
stopifnot(length(anova_vec) == length(sparsity_vec))

idx <- order(anova_vec, decreasing = T)[1:700]
col_vec <- rep("black", length(sparsity_vec))
col_vec[idx] <- "red"
pch_vec <- rep(1, length(sparsity_vec))
pch_vec[idx] <- 16
plot(sparsity_vec, sum_vec, ylim = c(0, quantile_sum),
     col = col_vec, pch = pch_vec)

```

```{r, echo = F}
dat2 <- dat[,idx]
res_svd <- svd(dat2)
```

Singular values

```{r, echo = F}
plot(sort(res_svd$d, decreasing = T)[1:50], pch = 16)
```

Left eigenvectors (Cells)

```{r, echo = F}
plot(res_svd$u[,1], res_svd$u[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```

Right eigenvectors (Genes)

```{r, echo = F}
plot(res_svd$v[,1], res_svd$v[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```



Most differentiated 
===

```{r, echo = F}
percentage_maximum <- function(x, class, prob = 1){
  idx <- which(zeisel$cell.info[,2] == class)
  threshold <- quantile(x[-idx], probs = prob)
  length(which(x[idx] > threshold))/length(idx)
}

percentage_mat <- apply(dat, 2, function(x){
  sapply(unique(zeisel$cell.info[,2]), function(y){
    percentage_maximum(x, y, prob = 0.95)
  })
})

apply(percentage_mat, 1, quantile)
```

```{r, echo = F}
idx_list <- lapply(1:7, function(x){
  order(percentage_mat[x,], decreasing = T)[1:100]
})
```

Most distinguished for each cell type

```{r, fig.height = 14, echo = F}
par(mfrow = c(7,2))
cell_idx <- as.numeric(as.factor(zeisel$cell.info[,2]))
for(i in 1:7){
  for(j in 1:2){
    plot(jitter(sort(dat[,idx_list[[i]][j]])), 
         col = c(1:7)[cell_idx[order(dat[,idx_list[[i]][j]])]],
         ylab = "")
  }
}
```

Least distinguished

```{r, fig.height = 14, echo = F}
par(mfrow = c(7,2))
cell_idx <- as.numeric(as.factor(zeisel$cell.info[,2]))
for(i in 1:7){
  for(j in 99:100){
    plot(jitter(sort(dat[,idx_list[[i]][j]])), 
         col = c(1:7)[cell_idx[order(dat[,idx_list[[i]][j]])]],
         ylab = "")
  }
}
```

Medium distinguished

```{r, fig.height = 14, echo = F}
par(mfrow = c(7,2))
cell_idx <- as.numeric(as.factor(zeisel$cell.info[,2]))
for(i in 1:7){
  for(j in 50:51){
    plot(jitter(sort(dat[,idx_list[[i]][j]])), 
         col = c(1:7)[cell_idx[order(dat[,idx_list[[i]][j]])]],
         ylab = "")
  }
}
```

```{r, echo = F}
stopifnot(ncol(percentage_mat) == length(sparsity_vec))

idx <- unlist(idx_list)
col_vec <- rep("black", length(sparsity_vec))
col_vec[idx] <- "red"
pch_vec <- rep(1, length(sparsity_vec))
pch_vec[idx] <- 16
plot(sparsity_vec, sum_vec, ylim = c(0, quantile_sum),
     col = col_vec, pch = pch_vec)
```

```{r, echo = F}
dat2 <- dat[,idx]
res_svd <- svd(dat2)
```

Singular values

```{r, echo = F}
plot(sort(res_svd$d, decreasing = T)[1:50], pch = 16)
```

Left eigenvectors (Cells)

```{r, echo = F}
plot(res_svd$u[,1], res_svd$u[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```

Right eigenvectors (Genes)

```{r, echo = F}
plot(res_svd$v[,1], res_svd$v[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```



Analysis using most differentiated
===

Removing cells with almost no counts anywhere

```{r, echo = F}
cell_sparsity <- apply(dat2, 1, function(x){
  length(which(x!=0))
})

plot(sort(cell_sparsity))
lines(c(-1e4, 1e4), rep(ncol(dat2)/2, 2), col = "red", lwd = 2)
```


```{r, echo = F}
dat3 <- dat2
cell_types <- zeisel$cell.info[idx,2]

dim(dat3)
```

```{r, eval = F, echo = F}
cbind(table(cell_types)/table(zeisel$cell.info[,2]), table(zeisel$cell.info[,2]))
```


```{r}
par(mfrow = c(1,2))
plot(table(dat3))
plot(table(dat3), ylim = c(0, 100))
```

```{r, echo = F}
res_svd <- svd(dat3)
```

Singular values

```{r, echo = F}
plot(sort(res_svd$d, decreasing = T)[1:50], pch = 16)
```

Left eigenvectors (Cells)

```{r, echo = F}
plot(res_svd$u[,1], res_svd$u[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```

Right eigenvectors (Genes)

```{r, echo = F}
plot(res_svd$v[,1], res_svd$v[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```

Modeling approximation

```{r}
dat_approx <- res_svd$u[,1:8] %*% diag(res_svd$d[1:8]) %*% t(res_svd$v[,1:8])
residual <- dat3 - dat_approx

set.seed(10)
idx <- sample(prod(dim(dat3)), 5e5)
plot(as.vector(dat_approx)[idx], as.vector(residual)[idx], pch = 16, xlab = "mean",
     ylab = "residual", col = rgb(0,0,0,0.1))
lines(c(-1e4, 1e4), rep(0,2), col = "red", lwd = 2)
```

```{r}
plot(as.numeric(dat_approx)[idx], as.numeric(dat)[idx], col = rgb(0,0,0,0.1))
mean_val <- seq(0, 500, by = 1)
lines(mean_val, mean_val, col = "red", lwd = 2)
sd_top <- mean_val + 3*sqrt(mean_val)
sd_bot <- mean_val - 3*sqrt(mean_val)
lines(mean_val, sd_top, col = "red", lwd = 2, lty = 2)
lines(mean_val, sd_bot, col = "red", lwd = 2, lty = 2)
```


Thresholding matrix
===

```{r, echo = F}
dat4 <- dat3
dat4[dat4 >= 30] <- 30
```

```{r, echo = F}
res_svd <- svd(dat4)
```

Singular values

```{r, echo = F}
plot(sort(res_svd$d, decreasing = T)[1:50], pch = 16)
```

Left eigenvectors (Cells)

```{r, echo = F}
plot(res_svd$u[,1], res_svd$u[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```

Right eigenvectors (Genes)

```{r, echo = F}
plot(res_svd$v[,1], res_svd$v[,2], pch = 16, col = rgb(0.1, 0.1, 0.1, 0.25))
```

Modeling approximation

```{r}
dat_approx <- res_svd$u[,1:7] %*% diag(res_svd$d[1:7]) %*% t(res_svd$v[,1:7])
residual <- dat4 - dat_approx

set.seed(10)
idx <- sample(prod(dim(dat4)), 5e5)
plot(as.vector(dat_approx)[idx], as.vector(residual)[idx], pch = 16, xlab = "mean",
     ylab = "residual", col = rgb(0,0,0,0.1))
lines(c(-1e4, 1e4), rep(0,2), col = "red", lwd = 2)
```

```{r}
plot(as.numeric(dat_approx)[idx], as.numeric(dat)[idx], col = rgb(0,0,0,0.1))
mean_val <- seq(0, 50, by = 0.25)
lines(mean_val, mean_val, col = "red", lwd = 2)
sd_top <- mean_val + 3*sqrt(mean_val)
sd_bot <- mean_val - 3*sqrt(mean_val)
lines(mean_val, sd_top, col = "red", lwd = 2, lty = 2)
lines(mean_val, sd_bot, col = "red", lwd = 2, lty = 2)
```


